name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup JUCE
      run: |
        git clone https://github.com/juce-framework/JUCE.git
        cd JUCE
        git checkout 6.1.6

    - name: Build macOS
      run: |
        cd ..
        xcodebuild -project Builds/MacOSX/Pulse24Sync.xcodeproj -configuration Release

    - name: Package macOS Assets
      run: |
        mkdir -p releases
        cd "/Users/runner/Library/Audio/Plug-Ins/Components"
        zip -r "../../releases/Pulse24Sync-AU-macOS-${{ github.ref_name }}.zip" Pulse24Sync.component || true
        cd "/Users/runner/Library/Audio/Plug-Ins/VST3"
        zip -r "../../releases/Pulse24Sync-VST3-macOS-${{ github.ref_name }}.zip" Pulse24Sync.vst3 || true
        cd "Builds/MacOSX/build/Release"
        zip -r "../../../releases/Pulse24Sync-Standalone-macOS-${{ github.ref_name }}.zip" Pulse24Sync.app || true

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-builds
        path: releases/
        retention-days: 1

  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup JUCE
      run: |
        git clone https://github.com/juce-framework/JUCE.git
        cd JUCE
        git checkout 6.1.6

    - name: Build Windows VST3
      run: |
        cd ..
        msbuild Builds\VisualStudio2022\Pulse24Sync.sln /p:Configuration=Release /p:Platform=x64 /p:BuildProjectReferences=true /m

    - name: Build Windows Standalone
      run: |
        msbuild Builds\VisualStudio2022\Pulse24Sync.sln /p:Configuration=Release /p:Platform=x64 /p:BuildProjectReferences=true /m /t:Pulse24Sync_StandalonePlugin

    - name: Package Windows Assets
      run: |
        mkdir -p releases
        cd "Builds\VisualStudio2022\build\Release"
        if exist "Pulse24Sync.vst3" (
          powershell Compress-Archive -Path "Pulse24Sync.vst3" -DestinationPath "..\..\..\releases\Pulse24Sync-VST3-Windows-${{ github.ref_name }}.zip"
        )
        if exist "Pulse24Sync.exe" (
          powershell Compress-Archive -Path "Pulse24Sync.exe" -DestinationPath "..\..\..\releases\Pulse24Sync-Standalone-Windows-${{ github.ref_name }}.zip"
        )

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-builds
        path: releases/
        retention-days: 1

  create-release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: macos-builds
        path: releases

    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-builds
        path: releases

    - name: Create Source Archive
      run: |
        git archive --format=zip --output=releases/Pulse24Sync-Source-${{ github.ref_name }}.zip HEAD

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          releases/Pulse24Sync-AU-macOS-${{ github.ref_name }}.zip
          releases/Pulse24Sync-VST3-macOS-${{ github.ref_name }}.zip
          releases/Pulse24Sync-Standalone-macOS-${{ github.ref_name }}.zip
          releases/Pulse24Sync-VST3-Windows-${{ github.ref_name }}.zip
          releases/Pulse24Sync-Standalone-Windows-${{ github.ref_name }}.zip
          releases/Pulse24Sync-Source-${{ github.ref_name }}.zip
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        generate_release_notes: false
        body: |
          ## Pulse24Sync ${{ github.ref_name }}

          ### üéâ Release
          - Complete VST3 and AU plugin implementation
          - 24 pulses per quarter note with tempo synchronization
          - Cross-platform support (macOS and Windows)
          - Modern dark theme UI with parameter automation

          ### üîß Features
          - **Tempo Sync**: Automatic synchronization with host tempo
          - **Pulse Generation**: Exactly 24 pulses per quarter note
          - **Parameter Controls**: Volume, pulse width, and enable/disable
          - **Real-time Processing**: Zero latency audio processing
          - **Cross-platform**: macOS (AU/VST3) and Windows (VST3)

          ### üöÄ Installation
          1. Download the appropriate plugin for your platform
          2. Extract the archive
          3. Copy to your DAW's plugin directory:
             - **macOS AU**: `/Library/Audio/Plug-Ins/Components/`
             - **macOS VST3**: `/Library/Audio/Plug-Ins/VST3/`
             - **Windows VST3**: `C:\Program Files\Common Files\VST3\`
          4. Restart your DAW and scan for new plugins

          ### üìã System Requirements
          - **macOS**: 10.13+ (Intel/Apple Silicon)
          - **Windows**: Windows 10+ (64-bit)
          - **DAW**: Any VST3 or AU compatible host

          ### üôè Acknowledgments
          Inspired by a request from Zac Caruso in the Synthesizer Zone Facebook group.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
